<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="estimation">

	<select id="selectOptionlist" parameterType="EgovMap"
		resultType="EgovMap">
		<![CDATA[
			SELECT
				CODE_ID
				,CODE_NM
			FROM 
				REF_CODE
			WHERE
				CODE_GROUP = #{codeGroup}
			ORDER BY
				CODE_ID ASC
		]]>
	</select>

	<!-- 기후 및 시나리오 전용 옵션 SELECT ver2 -->
	<select id="selectClimateOption" parameterType="EgovMap"
		resultType="EgovMap">
		SELECT DISTINCT 
		<choose>
			<when test="model != null and model != ''">
				YEAR_ID,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = YEAR_ID) as YEAR_NM
			</when>
			<when test="section != null and section != ''">
				MDL_ID, (SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = MDL_ID) as MDL_NM
			</when>
			<otherwise>
				RCP_ID,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = RCP_ID) as RCP_NM
			</otherwise>
		</choose>
		FROM 
			CLIMATE_OPTION_TEMP
		WHERE ITEM_ID = #{item}
			<if test="model != null and model != ''">
				AND MDL_ID = #{model} 
			</if>
			<if test="section != null and section != ''">
				AND RCP_ID = #{section}
			</if>
		ORDER BY 1 ASC			
	</select>

	<select id="selectItemlist" parameterType="EgovMap"
		resultType="EgovMap">
		<![CDATA[
			SELECT
				ITEM_ID
				,ITEM_NM
			FROM 
				ITEM_LIST 
			WHERE
				FIELD_ID = #{field}
			ORDER BY
				ITEM_ID ASC
		]]>
	</select>
	
	
	<!-- /* 추가된 부분 인천광역시 세트 */ -->
	
	<select id="selectItemlistAll" resultType="EgovMap">
		<![CDATA[
			SELECT
				ITEM_ID
			FROM 
				ITEM_LIST 
			WHERE 
				SUBSTR(ITEM_ID,7,2)::INTEGER < 48
			ORDER BY
				ITEM_ID ASC
		]]>
	</select>
	
	<select id="selectCombinelist" parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
			SELECT
				RCP_ID, YEAR_ID
			FROM 
				CLIMATE_OPTION 
			WHERE 
				MDL_ID = #{model}
			ORDER BY
				RCP_ID, YEAR_ID ASC
		]]>
	</select>
	
	<select id="selectIndicatorId" parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
			SELECT
				INDI_ID, SECTOR_ID
			FROM 
				ITEM_INDICATOR 
			WHERE 
				ITEM_ID = #{item}
			ORDER BY
				INDI_ID, SECTOR_ID ASC
		]]>
	</select>
	
	<!-- /* 추가된 부분 인천광역시 세트 */ -->
	
	<select id="selectSidoList" resultType="EgovMap">
		<![CDATA[
			SELECT
				DISTRICT_CD
				,DISTRICT_NM
			FROM 
				DISTRICT_SD  
			ORDER BY 
				DISTRICT_CD ASC
		]]>
	</select>

	<select id="selectSigungulist" parameterType="EgovMap"
		resultType="EgovMap">
		<![CDATA[
			SELECT
				SUBSTR(DISTRICT_CD, 0, 5) AS DISTRICT_CD , DISTRICT_NM
			FROM 
				DISTRICT_SGG 
			WHERE
				DISTRICT_CD LIKE #{sidoCode}||'%'
			ORDER BY
				DISTRICT_CD ASC
		]]>
	</select>

	<select id="selectEstimationResultEmdTotal" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
	SELECT DISTRICT_CD FROM DISTRICT_EMD 
	WHERE DISTRICT_CD LIKE 
	#{sigungu}
	||'%'
	)
	,E011 AS(
	SELECT A.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM, A.DISTRICT_NM AS EMD_NM FROM DISTRICT_EMD A
	JOIN DISTRICT_SGG B ON SUBSTR(A.DISTRICT_CD,1,4) = SUBSTR(B.DISTRICT_CD ,1,4)
	JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD 
	ORDER BY DISTRICT_CD ASC
	)
	,E02 AS (
	SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E021 AS (
	SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
	)
	,E022 AS (
	SELECT INDI_ID, DISTRICT_CD, CASE 
	WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
	END INDI_VAL 
	FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
	)
	,E03 AS (
	SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E031 AS (
	SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
	)	
	,E032 AS (
	SELECT SCEN_ID, DISTRICT_CD
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
	FROM E031 Y 
	)
	,E033 AS (
	SELECT SCEN_ID, DISTRICT_CD, CASE 
	WHEN M1_EMD_CNT > 0 THEN #{model}
	WHEN M1_SGG_CNT > 0 THEN #{model}
	WHEN M2_EMD_CNT > 0 THEN #{adjModel}
	WHEN M2_SGG_CNT > 0 THEN #{adjModel}
	END AS MDL_ID,
	CASE 
	WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	END AS SCEN_VAL
	FROM E032 Y
	)
	,E04 AS (
	SELECT INDI_ID, DISTRICT_CD, INDI_VAL FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL FROM E033
	)
	,E05 AS (
	SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
	)
	,E06 AS (
	SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
	)
	,E07 AS (
	SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
	)
	,E08 AS (
	SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
	WHERE ESTI.ITEM_ID = 
	#{item}
	)
	,E09 AS (
	SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
	)
	,E10 AS (
	SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
	)
	,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
	)
	,E12 AS (
	SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE 
	,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE 
	,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
	FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
	)
	,E13 AS(
	SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC) AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, EMD.SD_NM, EMD.SGG_NM, EMD.EMD_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
	JOIN E011 EMD ON ESTM.DISTRICT_CD = EMD.DISTRICT_CD 
	ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
	)
	 SELECT * FROM E13
	
	]]>
	</select>
	
		
	<select id="selectEstimationResultSggTotal" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
	SELECT DISTRICT_CD FROM DISTRICT_SGG 
	WHERE DISTRICT_CD LIKE 
	#{sido}
	||'%'
	)
	,E011 AS(
	SELECT B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM FROM DISTRICT_SGG B
	JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD
	]]>
	<if test="onlyCoastNear != null and onlyCoastNear.equals('true')">
		WHERE SUBSTR(B.DISTRICT_CD ,1,4) IN(${nearCoastSigunguCdStr})
	</if>
	<![CDATA[
	ORDER BY DISTRICT_CD ASC
	)
	,E02 AS (
	SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E021 AS (
	SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
	)
	,E022 AS (
	SELECT INDI_ID, DISTRICT_CD, CASE 
	WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
	END INDI_VAL 
	FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
	)
	,E03 AS (
	SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E031 AS (
	SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
	)
	,E032 AS (
	SELECT SCEN_ID, DISTRICT_CD
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
	FROM E031 Y 
	)
	,E033 AS (
	SELECT SCEN_ID, DISTRICT_CD, CASE 
	WHEN M1_EMD_CNT > 0 THEN #{model}
	WHEN M1_SGG_CNT > 0 THEN #{model}
	WHEN M2_EMD_CNT > 0 THEN #{adjModel}
	WHEN M2_SGG_CNT > 0 THEN #{adjModel}
	END AS MDL_ID,
	CASE 
	WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	END AS SCEN_VAL
	FROM E032 Y)
	,E04 AS (
	SELECT INDI_ID, DISTRICT_CD, INDI_VAL FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL FROM E033
	)
	,E05 AS (
	SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
	)
	,E06 AS (
	SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
	)
	,E07 AS (
	SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
	)
	,E08 AS (
	SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
	WHERE ESTI.ITEM_ID = 
	#{item}
	)
	,E09 AS (
	SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
	)
	,E10 AS (
	SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
	)
	,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
	)
	,E12 AS (
		SELECT ESWE.ITEM_ID, ESMS.ITEM_NM, ESWE.DISTRICT_CD, TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE, 
		TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE, 
		TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE,
		TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
		FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
	)
	,E13 AS(
	SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC) AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, SGG.SD_NM, SGG.SGG_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
	JOIN E011 SGG ON ESTM.DISTRICT_CD = SGG.DISTRICT_CD 
	ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
	)
	 SELECT * FROM E13
	
	]]>
	</select>
	
	<select id="selectEstimationIndiWeight" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
	SELECT DISTRICT_CD FROM DISTRICT_SGG 
	WHERE DISTRICT_CD LIKE 
	#{sido}
	||'%'
	)
	,E011 AS(
	SELECT B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM FROM DISTRICT_SGG B
	JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD
	]]>
	<if test="onlyCoastNear != null and onlyCoastNear.equals('true')">
		WHERE SUBSTR(B.DISTRICT_CD ,1,4) IN(${nearCoastSigunguCdStr})
	</if>
	<![CDATA[
	ORDER BY DISTRICT_CD ASC
	)
	,E02 AS (
	SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E021 AS (
	SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
	)
	,E022 AS (
	SELECT INDI_ID, DISTRICT_CD, CASE 
	WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
	END INDI_VAL 
	FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
	)
	,E03 AS (
	SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E031 AS (
	SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
	)
	,E032 AS (
	SELECT SCEN_ID, DISTRICT_CD
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
	FROM E031 Y 
	)
	,E033 AS (
	SELECT SCEN_ID, DISTRICT_CD, CASE 
	WHEN M1_EMD_CNT > 0 THEN #{model}
	WHEN M1_SGG_CNT > 0 THEN #{model}
	WHEN M2_EMD_CNT > 0 THEN #{adjModel}
	WHEN M2_SGG_CNT > 0 THEN #{adjModel}
	END AS MDL_ID,
	CASE 
	WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	END AS SCEN_VAL
	FROM E032 Y)
	,E04 AS (
	SELECT INDI_ID, DISTRICT_CD, INDI_VAL FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL FROM E033
	)
	,E05 AS (
	SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
	)
	,E06 AS (
	SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
	)
	,E07 AS (
	SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
	)
	,E08 AS (
	SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
	WHERE ESTI.ITEM_ID = 
	#{item}
	)
	,E09 AS (
	SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
	)
	,E10 AS (
	SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
	)
	,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
	)
	,E12 AS (
	SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE 
	,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE 
	,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
	FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
	)
	,E13 AS(
	SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC) AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, SGG.SD_NM, SGG.SGG_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
	JOIN E011 SGG ON ESTM.DISTRICT_CD = SGG.DISTRICT_CD 
	ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
	)
	SELECT 
		SECTOR_ID, 
		INDI_ID,
		CASE
			WHEN INDI_ID LIKE 'IC'||'%'
			THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = E08.INDI_ID) 
			WHEN INDI_ID LIKE 'SC'||'%'
			THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = E08.INDI_ID)
			END AS INDI_NM, DISTRICT_CD, 
			TRUNC(COALESCE(WEIGHT_GNRL_VALUE,0):: NUMERIC, 2)AS WEIGHT_GNRL_VALUE 
	FROM E08
	ORDER BY SECTOR_ID, INDI_ID, DISTRICT_CD
	]]>
	</select>
	
	<select id="selectEstimationEmdIndiWeight" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
	SELECT DISTRICT_CD FROM DISTRICT_EMD 
	WHERE DISTRICT_CD LIKE 
	#{sigungu}
	||'%'
	)
	,E011 AS(
	SELECT A.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM, A.DISTRICT_NM AS EMD_NM FROM DISTRICT_EMD A
	JOIN DISTRICT_SGG B ON SUBSTR(A.DISTRICT_CD,1,4) = SUBSTR(B.DISTRICT_CD ,1,4)
	JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD
	ORDER BY DISTRICT_CD ASC
	)
	,E02 AS (
	SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E021 AS (
	SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
	)
	,E022 AS (
	SELECT INDI_ID, DISTRICT_CD, CASE 
	WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
	WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
	END INDI_VAL 
	FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
	)
	,E03 AS (
	SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
	#{item}
	))
	,E031 AS (
	SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
	)	
	,E032 AS (
	SELECT SCEN_ID, DISTRICT_CD
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
	,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
	FROM E031 Y 
	)
	,E033 AS (
	SELECT SCEN_ID, DISTRICT_CD, CASE 
	WHEN M1_EMD_CNT > 0 THEN #{model}
	WHEN M1_SGG_CNT > 0 THEN #{model}
	WHEN M2_EMD_CNT > 0 THEN #{adjModel}
	WHEN M2_SGG_CNT > 0 THEN #{adjModel}
	END AS MDL_ID,
	CASE 
	WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
	END AS SCEN_VAL
	FROM E032 Y
	)
	,E04 AS (
	SELECT INDI_ID, DISTRICT_CD, INDI_VAL FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL FROM E033
	)
	,E05 AS (
	SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
	)
	,E06 AS (
	SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
	)
	,E07 AS (
	SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
	)
	,E08 AS (
	SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
	WHERE ESTI.ITEM_ID = 
	#{item}
	)
	,E09 AS (
	SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
	)
	,E10 AS (
	SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
	)
	,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
	)
	,E12 AS (
	SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE 
	,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE 
	,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
	FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
	)
	,E13 AS(
	SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC) AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, EMD.SD_NM, EMD.SGG_NM, EMD.EMD_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
	JOIN E011 EMD ON ESTM.DISTRICT_CD = EMD.DISTRICT_CD 
	ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
	)
 	SELECT 
 		SECTOR_ID, INDI_ID, 
 		CASE 
 			WHEN INDI_ID LIKE 'IC'||'%' THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = E08.INDI_ID) 
 			WHEN INDI_ID LIKE 'SC'||'%' THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = E08.INDI_ID) 
 		END AS INDI_NM, 
 		DISTRICT_CD, TRUNC(COALESCE(WEIGHT_GNRL_VALUE,0):: NUMERIC, 2)AS WEIGHT_GNRL_VALUE
	FROM E08
	ORDER BY SECTOR_ID, INDI_ID, DISTRICT_CD 
	
	]]>
	</select>
	
	<select id="selectEstimationResultSdTotal" parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		
		]]>
	</select>

	<select id="selectEstimationCalcFormula" parameterType="EgovMap"
		resultType="EgovMap">
		<![CDATA[
			SELECT 
				ITEM_ID
				, ITEM_NM
				, CE_WEIGHT
				, CS_WEIGHT
				, AA_WEIGHT
			FROM
				ITEM_LIST 
			WHERE 1=1
				AND ITEM_ID = #{item}
		]]>
	</select>
	
		<select id="selectEstimationResultDetail"
		parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		SELECT 
			NO
			,SECTOR_ID
			,SECTOR_NM
			,INDI_ID
			,INDI_NM
			,INDI_CONST_SIGN
			,INDI_CONSTRUCT_NM
			,INDI_VAL_WEIGHT
			,INDI_SPACE
			,MDL_ID
			,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = MDL_ID) AS MDL_NM
		FROM(
			SELECT
				NO
				,SECTOR_ID
				,SECTOR_NM
				,INDI_ID
				,INDI_NM
				,INDI_CONST_SIGN
				,INDI_CONSTRUCT_NM
				,INDI_VAL_WEIGHT
				,INDI_SPACE
				,CASE 
				WHEN M1_EMD_CNT > 0 THEN #{model}
				WHEN M1_SGG_CNT > 0 THEN #{model}
				WHEN M2_EMD_CNT > 0 THEN #{adjModel}
				WHEN M2_SGG_CNT > 0 THEN #{adjModel}
				END AS MDL_ID
			FROM(
			SELECT 
				ROW_NUMBER () OVER (ORDER BY SECTOR_ID ASC, A.INDI_ID ASC) AS NO
				, A.SECTOR_ID
				, (SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.SECTOR_ID) AS SECTOR_NM
				, B.INDI_ID
				, B.INDI_NM
				, CASE B.INDI_CONSTRUCT 
				WHEN 'VT001' THEN 'A' 
				WHEN 'VT002' THEN 'B' 
				WHEN 'VT003' THEN 'C' 
				WHEN 'VT008' THEN 'A`'
				WHEN 'VT004' THEN 'B`' 
				WHEN 'VT005' THEN 'C`' 
				WHEN 'VT006' THEN 'D' 
				WHEN 'VT007' THEN 'E' 
				END AS INDI_CONST_SIGN
				, (SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = B.INDI_CONSTRUCT) AS INDI_CONSTRUCT_NM
				, A.INDI_VAL_WEIGHT
				, B.INDI_SPACE
				,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = B.INDI_ID AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
				,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = B.INDI_ID AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
				,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = B.INDI_ID AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
				,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = B.INDI_ID AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
			FROM
				ITEM_INDICATOR A
			JOIN
				(SELECT
				 	INDI_ID, INDI_NM, INDI_CONSTRUCT, INDI_SPACE
				 FROM
				 	INDICATOR_LIST
				 UNION ALL
				 SELECT
				 	SCEN_ID, SCEN_NM, SCEN_CONSTRUCT, NULL
				 FROM
				 	SCENARIO_LIST
				 )B
			ON
				(A.INDI_ID = B.INDI_ID)
			WHERE A.ITEM_ID = #{item}
			ORDER BY SECTOR_ID ASC, INDI_ID ASC
			)X
		)Y	
		]]>
	</select>

		
	<select id="selectEstimationResultEmdData"
		parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_EMD 
		WHERE DISTRICT_CD LIKE 
		#{sigungu}
		||'%'
		)
		,E011 AS(
		SELECT A.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM, A.DISTRICT_NM AS EMD_NM FROM DISTRICT_EMD A
		JOIN DISTRICT_SGG B ON SUBSTR(A.DISTRICT_CD,1,5) = B.DISTRICT_CD
		JOIN DISTRICT_SD C ON SUBSTR(A.DISTRICT_CD,1,2) = C.DISTRICT_CD 
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID = 
		 #{indi}
		)
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		,INDI_YEAR
		FROM(
			SELECT INDI_ID, DISTRICT_CD, CASE 
			WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
			WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
			WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
			END INDI_YEAR
			,INDI_SPACE
			FROM E021 Y
			)Z
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID =
		 #{indi}
		)
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)		
		,E032 AS (
		SELECT SCEN_ID ,DISTRICT_CD 
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y)
		,E033 AS (
		SELECT SCEN_ID ,DISTRICT_CD
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})  
		END AS SCEN_VAL
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})  
		END AS  SCEN_YEAR
		FROM E032 Y)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, MDL_ID FROM E033
		)
		SELECT 
		ROW_NUMBER () OVER (ORDER BY A.DISTRICT_CD ASC) AS NO
		,B.DISTRICT_CD AS EMD_CD
		,B.DISTRICT_NM AS EMD_NM
		,CASE 
			WHEN A.INDI_VAL<1 THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','') 
			ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' '),'.00','')
		END AS INDI_VAL
		,A.INDI_YEAR
		,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID) AS MDL_NM
		FROM E04 A 
		JOIN 	
		DISTRICT_EMD B 
		ON (A.DISTRICT_CD = B.DISTRICT_CD)
		ORDER BY A.DISTRICT_CD ASC
	]]>
	</select>

	
	<select id="selectEstimationResultSggData"
		parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_SGG 
		WHERE DISTRICT_CD LIKE 
		#{sido}
		||'%'
		)
		,E011 AS(
		SELECT B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM FROM DISTRICT_SGG B 
		JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD 
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID = 
		 #{indi}
		)
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		,INDI_YEAR
		FROM(
			SELECT INDI_ID, DISTRICT_CD, ]]>
			<choose>
				<when test="indiItem != null and indiItem.size!=0">
					CASE
					<foreach collection="indiItem" item="item" separator=" ">
						WHEN INDI_ID = #{item.indiId}
						THEN #{item.indiYear}
					</foreach>
					END INDI_YEAR	
				</when>
				<otherwise>
					CASE
						WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
						WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
						WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
					END INDI_YEAR
				</otherwise>
			</choose>
			,INDI_SPACE
			FROM E021 Y
			)Z
			<![CDATA[
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID =
		 #{indi}
		)
		,E031 AS (
		SELECT A.SCEN_ID, SUBSTR(B.DISTRICT_CD,1,4) AS DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID ,DISTRICT_CD 
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y)
		,E033 AS (
		SELECT SCEN_ID ,DISTRICT_CD || '0' AS DISTRICT_CD
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT TRUNC(AVG(SCEN_VAL),2) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT TRUNC(AVG(SCEN_VAL),2) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		END AS SCEN_VAL
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		END AS  SCEN_YEAR
		FROM E032 Y)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, MDL_ID FROM E033
		)
		SELECT 
		ROW_NUMBER () OVER (ORDER BY A.DISTRICT_CD ASC) AS NO
		,B.DISTRICT_CD AS SGG_CD
		,B.DISTRICT_NM AS SGG_NM
		,CASE 
			WHEN A.INDI_VAL<1 THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','')
			ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' '),'.00','')
		END AS INDI_VAL
		,A.INDI_YEAR 
		,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID) AS MDL_NM
		FROM E04 A 
		JOIN 	
		DISTRICT_SGG B 
		ON (A.DISTRICT_CD = B.DISTRICT_CD)
		ORDER BY A.DISTRICT_CD ASC
	]]>
	</select>
	
	<select id="selectEstimationResultSdData"
		parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_SD
		)
		,E011 AS(
		SELECT DISTRICT_CD, DISTRICT_NM AS SD_NM FROM DISTRICT_SD
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID = 
		 #{indi}
		)
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		,INDI_YEAR
		FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID =
		 #{indi}
		)
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID ,DISTRICT_CD 
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y)
		,E033 AS (
		SELECT SCEN_ID ,DISTRICT_CD
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_VAL
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS  SCEN_YEAR
		FROM E032 Y)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, MDL_ID FROM E033
		)
		SELECT 
		ROW_NUMBER () OVER (ORDER BY A.DISTRICT_CD ASC) AS NO
		,B.SD_NM
		,CASE 
		WHEN A.INDI_VAL<1 THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','') 
		ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' 
		'),'.00','') END AS INDI_VAL
		,A.INDI_YEAR 
		,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID) AS MDL_NM
		FROM E04 A JOIN E011 B ON (A.DISTRICT_CD = B.DISTRICT_CD) ORDER BY INDI_ID, A.DISTRICT_CD 
		ASC 
		]]>
	</select>

	<select id="selectEstimationIndiInfo" parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
			WITH E01 AS (
			SELECT INDI_ID,INDI_NM,INDI_UNIT,INDI_SPACE, INDI_CONSTRUCT, NULL::TEXT AS MDL_NM FROM INDICATOR_LIST WHERE INDI_ID = #{indi}
			)
			,E02 AS (
			SELECT SCEN_ID,SCEN_NM,SCEN_UNIT, CASE 
			WHEN SCEN_CONSTRUCT = 'VT001' OR SCEN_CONSTRUCT = 'VT007' THEN 'SPA01'
			WHEN SCEN_CONSTRUCT = 'VT002' THEN 'SPA02'
			ELSE NULL END AS SCEN_SPACE
			,SCEN_CONSTRUCT
			,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = A.SCEN_ID AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
			,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = A.SCEN_ID AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
			,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = A.SCEN_ID AND LENGTH(X.DISTRICT_CD)=7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
			,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = A.SCEN_ID AND LENGTH(X.DISTRICT_CD)=5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
			FROM SCENARIO_LIST A WHERE SCEN_ID = #{indi}
			)
			,E03 AS (
			SELECT SCEN_ID, SCEN_NM, SCEN_UNIT, SCEN_SPACE, SCEN_CONSTRUCT
			,CASE 
			WHEN M1_EMD_CNT > 0 THEN #{model}
			WHEN M1_SGG_CNT > 0 THEN #{model}
			WHEN M2_EMD_CNT > 0 THEN #{adjModel}
			WHEN M2_SGG_CNT > 0 THEN #{adjModel}
			END AS MDL_ID
			FROM E02
			)
			,E04 AS (
			SELECT SCEN_ID, SCEN_NM, SCEN_UNIT, SCEN_SPACE, SCEN_CONSTRUCT
			,MDL_ID
			,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = MDL_ID) AS MDL_NM
			FROM E03
			)
			SELECT INDI_ID, INDI_NM, INDI_UNIT, INDI_SPACE, INDI_CONSTRUCT, MDL_NM FROM E01
			UNION ALL
			SELECT SCEN_ID, SCEN_NM, SCEN_UNIT, SCEN_SPACE, SCEN_CONSTRUCT, MDL_NM FROM E04
		]]>
	</select>

	<insert id="insertEstimationLog" parameterType="EgovMap">
		<![CDATA[
			INSERT INTO
				ESTIMATION_LOG
				(
				LOG_DATE
				,FIELD_ID
				,ITEM_ID
				,MODEL_ID
				,SECTION_ID
				,YEAR_ID
				,DISTRICT_CD
				,USER_ID
				)
			VALUES(
				DEFAULT
				,#{field}
				,#{item}
				,#{model}
				,#{section}
				,#{year}
				,#{districtCd}
				,#{userId}
				)
		]]>
	</insert>

	<update id="updateUserInfo" parameterType="EgovMap">
		<![CDATA[
			UPDATE 
				USER_INFO		
			SET
				USER_FLD = #{field}
				,USER_ITEM = #{item}
				,USER_SCR = #{model}
				,USER_RCP = #{section}
				,USER_YEAR = #{year}
				,USER_DISTRICT = #{districtCd}
			WHERE
				USER_ID = #{userId}
		]]>
	</update>

	<select id="selectIndicatorlist" parameterType="EgovMap"
		resultType="EgovMap">
		<if test="sector == 'SEC01'">
		<![CDATA[
			SELECT 
				SCEN_ID AS INDI_ID
				,SCEN_NM AS INDI_NM
			FROM 
				SCENARIO_LIST
			WHERE
				SCEN_ID IN (
		]]>
		</if>
		<if test="sector != 'SEC01'">
		<![CDATA[
			SELECT 
				INDI_ID 
				,INDI_NM
			FROM 
				INDICATOR_LIST
			WHERE
				INDI_ID IN (
		]]>
		</if>
		<![CDATA[
			SELECT DISTINCT INDI_ID FROM ITEM_INDICATOR WHERE 1=1 AND ITEM_ID = #{item} AND SECTOR_ID = #{sector}
			)
		]]>
	</select>
	
	<update id="moveEstimation" parameterType="EgovMap">
		UPDATE 
			USER_INFO A
		SET 
			USER_FLD = FIELD_ID
			, USER_ITEM = ITEM_ID
			, USER_SCR = MODEL_ID
			, USER_RCP = SECTION_ID
			, USER_YEAR = YEAR_ID 
			, USER_DISTRICT = DISTRICT_CD
		FROM 
			ESTIMATION_LOG B
		WHERE  
			A.USER_ID = B.USER_ID
			AND LOG_ID = #{key}::integer
	</update>
	
	<update id="moveEstimationNew" parameterType="Egovmap">
		UPDATE
			USER_INFO
		SET
			USER_RCP = #{section},
			USER_SCR = #{model},
			USER_FLD = (SELECT FIELD_ID FROM ITEM_LIST WHERE ITEM_ID = #{key}),
			USER_DIST = #{sidoCode},
			USER_YEAR = #{year},
			USER_ITEM = #{key}
		WHERE
			USER_ID = #{userId}
	</update>
	
	<update id="subEstimation" parameterType="EgovMap">
		UPDATE 
			USER_INFO
		SET 
			USER_DISTRICT = #{districtCd}
		WHERE  
			USER_ID = #{userId}
	</update>
	
	<select id="selectEstimationInfo" parameterType="EgovMap"
		resultType="EgovMap">
		SELECT 
			<if test="field != null">
			(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = #{field}) AS FIELD_NM
			</if>
			<if test="field == null">
			(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = (SELECT FIELD_ID FROM ITEM_LIST WHERE ITEM_ID = #{item})) AS FIELD_NM
			</if>
			,(SELECT ITEM_NM FROM ITEM_LIST WHERE ITEM_ID = #{item}) AS ITEM_NM
			,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = #{model}) AS MODEL_NM
			,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = #{section}) AS SECTION_NM
			,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = #{year}) AS YEAR_NM
			,(SELECT DISTRICT_NM FROM DISTRICT_SD WHERE DISTRICT_CD = #{sido}) AS SIDO_NM
			<if test="sigungu != ''">
			,(SELECT DISTRICT_NM FROM DISTRICT_SGG WHERE DISTRICT_CD = #{sigungu}) AS SIGUNGU_NM	
			</if>
	</select>
	
	<select id="selectIndiHeader" parameterType="EgovMap" resultType="EgovMap">
	SELECT A.INDI_ID, B.INDI_NM,A.SECTOR_ID, B.INDI_UNIT FROM (SELECT INDI_ID,SECTOR_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})A JOIN INDICATOR_LIST B ON A.INDI_ID = B.INDI_ID
	UNION ALL
	SELECT A.INDI_ID, B.SCEN_NM,A.SECTOR_ID, B.SCEN_UNIT FROM (SELECT INDI_ID,SECTOR_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})A JOIN SCENARIO_LIST B ON A.INDI_ID = B.SCEN_ID ORDER BY INDI_ID ASC
	</select>
	
	<select id="selectEmdIndiBody" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_EMD 
		WHERE DISTRICT_CD LIKE 
		#{sigungu}
		||'%'
		)
		,E011 AS(
		SELECT A.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM, A.DISTRICT_NM AS EMD_NM FROM DISTRICT_EMD A
		JOIN DISTRICT_SGG B ON SUBSTR(A.DISTRICT_CD,1,4)||'0' = B.DISTRICT_CD
		JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD 
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		,INDI_YEAR
		FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID ,DISTRICT_CD 
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y)
		,E033 AS (
		SELECT SCEN_ID ,DISTRICT_CD
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		END AS SCEN_VAL
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		END AS  SCEN_YEAR
		FROM E032 Y)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, NULL AS MDL_ID, INDI_VAL, INDI_YEAR FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, MDL_ID, SCEN_VAL, SCEN_YEAR FROM E033
		)
		SELECT A.INDI_ID ,(SELECT SECTOR_ID FROM ITEM_INDICATOR B WHERE A.INDI_ID=B.INDI_ID AND ITEM_ID=#{item}) AS SECTOR_ID
		,A.DISTRICT_CD ,B.EMD_NM ,CASE WHEN A.INDI_VAL<1 
		THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','') ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' 
		'),'.00','') END AS INDI_VAL
		FROM E04 A JOIN E011 B ON (A.DISTRICT_CD = B.DISTRICT_CD) ORDER BY INDI_ID,DISTRICT_CD 
		ASC 
		]]>
	</select>
	
	<select id="selectSggIndiBody" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_SGG 
		WHERE DISTRICT_CD LIKE 
		#{sido}
		||'%'
		)
		,E011 AS(
		SELECT B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM FROM DISTRICT_SGG B 
		JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD 
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		,INDI_YEAR
		FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E031 AS (
		SELECT A.SCEN_ID, SUBSTR(B.DISTRICT_CD,1,4) AS DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID ,DISTRICT_CD , (SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y)
		,E033 AS (
		SELECT SCEN_ID ,DISTRICT_CD || '0' AS DISTRICT_CD
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_VAL
		, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS  SCEN_YEAR
		FROM E032 Y)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR FROM E033
		)
		SELECT A.INDI_ID ,(SELECT SECTOR_ID FROM ITEM_INDICATOR B WHERE A.INDI_ID=B.INDI_ID AND ITEM_ID=#{item}) AS SECTOR_ID
		,A.DISTRICT_CD ,B.SGG_NM ,CASE WHEN A.INDI_VAL<1 
		THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','') ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' 
		'),'.00','') END AS INDI_VAL
		FROM E04 A JOIN E011 B ON (A.DISTRICT_CD = B.DISTRICT_CD) ORDER BY INDI_ID,DISTRICT_CD 
		ASC 
	]]>
	</select>
				
					
	<select id="selectWholeIndiBody" parameterType="EgovMap" resultType="EgovMap">
	<![CDATA[
	SELECT
		A.INDI_ID 
		,A.SECTOR_ID
		,A.DISTRICT_CD
		,B.DISTRICT_NM AS SGG_NM
		,CASE 
		WHEN A.INDI_VAL<1 THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','')
		ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' '),'.00','')
		END AS INDI_VAL
	FROM
		( 		
		SELECT * FROM(
				SELECT INDI_ID, DISTRICT_CD, 
				CASE  
					WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
				END INDI_VAL,
				CASE  
					WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
				END INDI_YEAR
				,(SELECT SECTOR_ID FROM ITEM_INDICATOR B WHERE Y.INDI_ID=B.INDI_ID AND ITEM_ID=#{item}) AS SECTOR_ID
				FROM
				(
				SELECT A.*, B.DISTRICT_CD
				FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE	ITEM_ID=#{item}))A
				RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE	ITEM_ID=#{item})) B
				ON A.INDI_ID = B.INDI_ID
				ORDER BY INDI_ID, DISTRICT_CD
				)Y
				)Z WHERE INDI_VAL IS NOT NULL
		UNION ALL
			SELECT 
				SCEN_ID
				, DISTRICT_CD
				, SCEN_VAL
				, VALUE_YEAR 
				,(SELECT SECTOR_ID FROM ITEM_INDICATOR B WHERE S.SCEN_ID=B.INDI_ID AND ITEM_ID=#{item}) AS SECTOR_ID
			FROM 
				SCENARIO_DATA S
			WHERE 1=1
				AND SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE	ITEM_ID=#{item})
				AND MDL_ID = #{model} 
				AND SCEN_SECTION = #{section}
 				AND SCEN_YEAR = #{year}
		)A
		JOIN DISTRICT_SGG B ON (A.DISTRICT_CD = B.DISTRICT_CD) ORDER BY INDI_ID,DISTRICT_CD ASC 
		]]>
	</select>
				
	<select id="selectWholeEstimation" parameterType="EgovMap" resultType="EgovMap">
			SELECT 
				ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC)::TEXT AS NO
				, ESTM.ITEM_NM
				, left(ESTM.DISTRICT_CD,4) as DISTRICT_CD
				, EMD.SD_NM
				, EMD.SGG_NM
				, ESTM.CLIM_VALUE
				, ESTM.SENS_VALUE
				, ESTM.ADAP_VALUE
				, ESTM.ESTI_VALUE
			FROM
				(
				SELECT
					ESWE.ITEM_ID
					, ESMS.ITEM_NM
					, ESWE.DISTRICT_CD
					, TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE
					, TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE
					, TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE
					, TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
				FROM 
					ITEM_LIST ESMS
				RIGHT JOIN
				(
				SELECT 
					ESTB.ITEM_ID
					, ESTB.DISTRICT_CD
					, SUM(ESTB.CLIM) AS CLIM_VALUE
					, SUM(ESTB.SENS) AS SENS_VALUE
					, SUM(ESTB.ADAP) AS ADAP_VALUE
				FROM
					(
					SELECT 
						ESRS.ITEM_ID
						, ESRS.DISTRICT_CD
						, CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM
						, CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS
						, CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP
					FROM
						(
						SELECT 
							GRSM.ITEM_ID
							,GRSM.SECTOR_ID
							,GRSM.DISTRICT_CD
							,SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE 
						FROM
							(
							SELECT 
								ESTI.ITEM_ID
								, ESTI.SECTOR_ID
								, ESTI.INDI_ID
								, INDI.DISTRICT_CD
								, ESTI.INDI_VAL_WEIGHT
								, INDI.GNRL_VALUE
								, (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE 
							FROM
								ITEM_INDICATOR ESTI
							JOIN 
								(
								SELECT RSLT.INDI_ID
								, RSLT.DISTRICT_CD
								, CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE
								FROM
									(
									SELECT 
										BASE.INDI_ID
										, BASE.DISTRICT_CD
										, BASE.INDI_VAL
										, GNRL.MAX_VALUE
										, GNRL.MIN_VALUE
									FROM
										(
										SELECT * FROM (
										SELECT INDI_ID, DISTRICT_CD, INDI_VAL
										FROM INDICATOR_DATA
										WHERE (INDI_ID, DISTRICT_CD, INDI_YEAR)
										IN(
											SELECT A.INDI_ID, A.DISTRICT_CD, MAX(B.INDI_YEAR)
											FROM (
												SELECT A.*, B.DISTRICT_CD
												FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item}))A
												RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})) B
												ON A.INDI_ID = B.INDI_ID
												ORDER BY INDI_ID, DISTRICT_CD
											)A, INDICATOR_DATA B
											WHERE 1=1 AND A.INDI_ID = B.INDI_ID
											AND 
											CASE  
											WHEN INDI_SPACE='SPA01' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD 
											WHEN INDI_SPACE='SPA02' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD
											WHEN INDI_SPACE='SPA03' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = SUBSTR(B.DISTRICT_CD,1,2) 
											END 
											GROUP BY A.INDI_ID, A.DISTRICT_CD
										)
										ORDER BY INDI_ID, DISTRICT_CD
										)Z WHERE INDI_VAL IS NOT NULL
										UNION ALL
										SELECT 
											SCEN_ID
											, SUBSTR(DISTRICT_CD,1,5) AS DISTRICT_CD
											, AVG(SCEN_VAL)AS SCEN_VAL
										FROM 
											SCENARIO_DATA
										WHERE 1=1 
	 										AND SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
											AND MDL_ID = #{model}
											AND SCEN_SECTION = #{section}
											AND SCEN_YEAR = #{year}
										GROUP BY SCEN_ID,SUBSTR(DISTRICT_CD,1,5)
		 								) AS BASE
		 								LEFT JOIN
	 										(
	 										SELECT 
	 											BASE.INDI_ID
	 											, MAX(BASE.INDI_VAL) AS MAX_VALUE
	 											, MIN(BASE.INDI_VAL) AS MIN_VALUE
	 										FROM
	 											(
	 											SELECT * FROM (
												SELECT INDI_ID, DISTRICT_CD, INDI_VAL
												FROM INDICATOR_DATA
												WHERE (INDI_ID, DISTRICT_CD, INDI_YEAR)
												IN(
													SELECT A.INDI_ID, A.DISTRICT_CD, MAX(B.INDI_YEAR)
													FROM (
														SELECT A.*, B.DISTRICT_CD
														FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item}))A
														RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})) B
														ON A.INDI_ID = B.INDI_ID
														ORDER BY INDI_ID, DISTRICT_CD
													)A, INDICATOR_DATA B
													WHERE 1=1 AND A.INDI_ID = B.INDI_ID
													AND 
													CASE  
													WHEN INDI_SPACE='SPA01' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD 
													WHEN INDI_SPACE='SPA02' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD
													WHEN INDI_SPACE='SPA03' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = SUBSTR(B.DISTRICT_CD,1,2) 
													END 
													GROUP BY A.INDI_ID, A.DISTRICT_CD
												)
												ORDER BY INDI_ID, DISTRICT_CD
												)Z WHERE INDI_VAL IS NOT NULL
											UNION ALL
											SELECT 
												SCEN_ID
												, SUBSTR(DISTRICT_CD,1,5) AS DISTRICT_CD
												, AVG(SCEN_VAL) AS SCEN_VAL
											FROM 
												SCENARIO_DATA
											WHERE 1=1 
			 									AND SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
												AND MDL_ID = #{model}
												AND SCEN_SECTION = #{section}
												AND SCEN_YEAR = #{year}
											GROUP BY SCEN_ID,SUBSTR(DISTRICT_CD,1,5)
											) AS BASE
										GROUP BY INDI_ID 
										)AS GNRL
										ON BASE.INDI_ID = GNRL.INDI_ID
										ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD
									)AS RSLT
								)AS INDI
								ON ESTI.INDI_ID = INDI.INDI_ID
								WHERE 
									ESTI.ITEM_ID = #{item}
								ORDER BY INDI.DISTRICT_CD ASC, ESTI.SECTOR_ID ASC,ESTI.INDI_ID ASC
							)AS GRSM
							GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD
							ORDER BY GRSM.ITEM_ID ASC,GRSM.DISTRICT_CD ASC
						)AS ESRS
						ORDER BY ESRS.DISTRICT_CD ASC
					)ESTB
					GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
					ORDER BY ESTB.ITEM_ID ASC, ESTB.DISTRICT_CD ASC
				)ESWE
				ON ESWE.ITEM_ID = ESMS.ITEM_ID
			)ESTM
			JOIN 
			(
			SELECT 
				B.DISTRICT_CD
				, C.DISTRICT_NM AS SD_NM
				, B.DISTRICT_NM AS SGG_NM
			FROM 
				DISTRICT_SGG B
			JOIN DISTRICT_SD C
			ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD
			ORDER BY B.DISTRICT_CD ASC
			)EMD
			ON ESTM.DISTRICT_CD = EMD.DISTRICT_CD
			ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
	</select>
	
	<select id="selectWholeIndiWeight" parameterType="EgovMap" resultType="EgovMap">
		SELECT 
			esti.sector_id ,
			esti.indi_id ,
			CASE 
				WHEN esti.INDI_ID LIKE 'IC'||'%' THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = esti.INDI_ID) 
				WHEN esti.INDI_ID LIKE 'SC'||'%' THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = esti.INDI_ID) 
			END AS INDI_NM,
			indi.district_cd ,
			TRUNC(COALESCE((esti.indi_val_weight * indi.gnrl_value),0):: NUMERIC, 2)AS WEIGHT_GNRL_VALUE  
		FROM
			ITEM_INDICATOR ESTI
		JOIN 
			(
			SELECT RSLT.INDI_ID
			, RSLT.DISTRICT_CD
			, CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE
			FROM
				(
				SELECT 
					BASE.INDI_ID
					, BASE.DISTRICT_CD
					, BASE.INDI_VAL
					, GNRL.MAX_VALUE
					, GNRL.MIN_VALUE
				FROM
					(
					SELECT * FROM (
					SELECT INDI_ID, DISTRICT_CD, INDI_VAL
					FROM INDICATOR_DATA
					WHERE (INDI_ID, DISTRICT_CD, INDI_YEAR)
					IN(
						SELECT A.INDI_ID, A.DISTRICT_CD, MAX(B.INDI_YEAR)
						FROM (
							SELECT A.*, B.DISTRICT_CD
							FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item}))A
							RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})) B
							ON A.INDI_ID = B.INDI_ID
							ORDER BY INDI_ID, DISTRICT_CD
						)A, INDICATOR_DATA B
						WHERE 1=1 AND A.INDI_ID = B.INDI_ID
						AND 
						CASE  
						WHEN INDI_SPACE='SPA01' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD 
						WHEN INDI_SPACE='SPA02' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD
						WHEN INDI_SPACE='SPA03' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = SUBSTR(B.DISTRICT_CD,1,2) 
						END 
						GROUP BY A.INDI_ID, A.DISTRICT_CD
					)
					ORDER BY INDI_ID, DISTRICT_CD
					)Z WHERE INDI_VAL IS NOT NULL
					UNION ALL
					SELECT 
						SCEN_ID
						, SUBSTR(DISTRICT_CD,1,5) AS DISTRICT_CD
						, AVG(SCEN_VAL)AS SCEN_VAL
					FROM 
						SCENARIO_DATA
					WHERE 1=1 
							AND SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
						AND MDL_ID = #{model}
						AND SCEN_SECTION = #{section}
						AND SCEN_YEAR = #{year}
					GROUP BY SCEN_ID,SUBSTR(DISTRICT_CD,1,5)
						) AS BASE
						LEFT JOIN
							(
							SELECT 
								BASE.INDI_ID
								, MAX(BASE.INDI_VAL) AS MAX_VALUE
								, MIN(BASE.INDI_VAL) AS MIN_VALUE
							FROM
								(
								SELECT * FROM (
							SELECT INDI_ID, DISTRICT_CD, INDI_VAL
							FROM INDICATOR_DATA
							WHERE (INDI_ID, DISTRICT_CD, INDI_YEAR)
							IN(
								SELECT A.INDI_ID, A.DISTRICT_CD, MAX(B.INDI_YEAR)
								FROM (
									SELECT A.*, B.DISTRICT_CD
									FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item}))A
									RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})) B
									ON A.INDI_ID = B.INDI_ID
									ORDER BY INDI_ID, DISTRICT_CD
								)A, INDICATOR_DATA B
								WHERE 1=1 AND A.INDI_ID = B.INDI_ID
								AND 
								CASE  
								WHEN INDI_SPACE='SPA01' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD 
								WHEN INDI_SPACE='SPA02' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = B.DISTRICT_CD
								WHEN INDI_SPACE='SPA03' THEN A.INDI_ID = B.INDI_ID AND A.DISTRICT_CD = SUBSTR(B.DISTRICT_CD,1,2) 
								END 
								GROUP BY A.INDI_ID, A.DISTRICT_CD
							)
							ORDER BY INDI_ID, DISTRICT_CD
							)Z WHERE INDI_VAL IS NOT NULL
						UNION ALL
						SELECT 
							SCEN_ID
							, SUBSTR(DISTRICT_CD,1,5) AS DISTRICT_CD
							, AVG(SCEN_VAL) AS SCEN_VAL
						FROM 
							SCENARIO_DATA
						WHERE 1=1 
								AND SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
							AND MDL_ID = #{model}
							AND SCEN_SECTION = #{section}
							AND SCEN_YEAR = #{year}
						GROUP BY SCEN_ID,SUBSTR(DISTRICT_CD,1,5)
						) AS BASE
					GROUP BY INDI_ID 
					)AS GNRL
					ON BASE.INDI_ID = GNRL.INDI_ID
					ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD
				)AS RSLT
			)AS INDI
			ON ESTI.INDI_ID = INDI.INDI_ID
			WHERE 
				ESTI.ITEM_ID = #{item}
			ORDER BY ESTI.SECTOR_ID ASC , ESTI.INDI_ID ASC , INDI.DISTRICT_CD ASC
	</select>
	
	<select id="selectEstimationResultWholeData"
		parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
			SELECT 
				ROW_NUMBER () OVER (ORDER BY A.DISTRICT_CD DESC) AS NO
				,B.DISTRICT_NM AS SGG_NM
				,A.INDI_VAL
				,A.INDI_YEAR
			FROM (
				SELECT * FROM(
				SELECT INDI_ID, DISTRICT_CD, 
				CASE  
					WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
				END INDI_VAL,
				CASE  
					WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_YEAR FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
				END INDI_YEAR
				FROM
				(
				SELECT A.*, B.DISTRICT_CD
				FROM (SELECT INDI_ID,INDI_SPACE,INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID =#{indi})A
				RIGHT OUTER JOIN (SELECT INDI_ID,DISTRICT_CD FROM INDICATOR_DATA WHERE INDI_ID =#{indi}) B
				ON A.INDI_ID = B.INDI_ID
				ORDER BY INDI_ID, DISTRICT_CD
				)Y
				)Z WHERE INDI_VAL IS NOT NULL
				UNION ALL
				SELECT 
					SCEN_ID
					, DISTRICT_CD
					, SCEN_VAL
					, VALUE_YEAR 
				FROM 
					SCENARIO_DATA
				WHERE 1=1
					AND SCEN_ID = #{indi}
					AND MDL_ID = #{model} 
					AND SCEN_SECTION = #{section}
	 				AND SCEN_YEAR = #{year}
			) A 
			JOIN 	
				DISTRICT_SGG B 
				ON (A.DISTRICT_CD = B.DISTRICT_CD)
			ORDER BY A.DISTRICT_CD DESC
		]]>
	</select>
</mapper>