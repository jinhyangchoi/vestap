<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wholeEstimation">
	<sql id="wholeEmd">
		<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_EMD
		)
		,E011 AS(
		SELECT
		       B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, D.DISTRICT_NM AS SGG_NM , B.DISTRICT_NM AS EMD_NM
	   	FROM
	   	     DISTRICT_EMD B
		JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD
		JOIN DISTRICT_SGG D ON SUBSTR(B.DISTRICT_CD,1,4) = SUBSTR(D.DISTRICT_CD, 1,4)
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT
		       INDI_ID,INDI_SPACE,
		       (SELECT SECTOR_ID FROM ITEM_INDICATOR WHERE ITEM_ID = #{item} AND ITEM_INDICATOR.INDI_ID = INDICATOR_LIST.INDI_ID) AS SECTOR_ID
		FROM INDICATOR_LIST
		WHERE INDI_ID IN (SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
		)
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE, A.SECTOR_ID FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR)
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR)
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR)
		END INDI_VAL, INDI_YEAR, SECTOR_ID
		FROM(
		SELECT INDI_ID, DISTRICT_CD,
		]]>
		<choose>
			<when test="indiItem != null and indiItem.size!=0">
				CASE
				<foreach collection="indiItem" item="item" separator=" ">
					WHEN INDI_ID = #{item.indiId}
					THEN #{item.indiYear}
				</foreach>
				END INDI_YEAR
			</when>
			<otherwise>
				CASE
				WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD)
				WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5))
				WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2))
				END INDI_YEAR
			</otherwise>
		</choose>
		,INDI_SPACE, SECTOR_ID
		FROM E021 Y
		)Z
		<![CDATA[
		)
		,E03 AS (
			SELECT SCEN_ID,SCEN_CONSTRUCT
			FROM SCENARIO_LIST
			WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=#{item})
		)
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT
		       SCEN_ID, DISTRICT_CD,
		       (SELECT COUNT(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT,
		       (SELECT COUNT(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		FROM E031 Y
		)
		,E033 AS (
		SELECT SCEN_ID, DISTRICT_CD, CASE
		    WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
			WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_VAL,
		CASE
		    WHEN M1_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
			WHEN M2_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_YEAR,
		CASE
			WHEN M1_EMD_CNT > 0 THEN #{model}
			WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		END AS MDL_ID

		FROM E032 Y
		)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, SECTOR_ID, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, '' AS SECTOR_ID, MDL_ID FROM E033
		)
		,E05 AS (
		SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID
		)
		,E06 AS (
		SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD
		)
		,E07 AS (
		SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
		)
		,E08 AS (
		SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID
		WHERE ESTI.ITEM_ID =
		#{item}
		)
		,E09 AS (
		SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD
		)
		,E10 AS (
		SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
		)
		,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
		)
		,E12 AS (
		SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE
		,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE
		,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
		FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID
		)
		,E13 AS(
		SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC)::TEXT AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, EMD.SD_NM, EMD.SGG_NM, EMD.EMD_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
		JOIN E011 EMD ON ESTM.DISTRICT_CD = EMD.DISTRICT_CD
		ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
		)
		]]>
	</sql>
	<sql id="wholeSgg">
	<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_SGG 
		)
		,E011 AS(
		SELECT B.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM FROM DISTRICT_SGG B
		JOIN DISTRICT_SD C ON SUBSTR(B.DISTRICT_CD,1,2) = C.DISTRICT_CD 
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL, INDI_YEAR
		FROM(
		SELECT INDI_ID, DISTRICT_CD, 
		]]>
		<choose>
			<when test="indiItem != null and indiItem.size!=0">
				CASE 
				<foreach collection="indiItem" item="item" separator=" ">
					WHEN INDI_ID = #{item.indiId}
					THEN #{item.indiYear}
				</foreach>
				END INDI_YEAR
			</when>
			<otherwise>
				CASE 
					WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
					WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
					WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
				END INDI_YEAR
			</otherwise>
		</choose>
		,INDI_SPACE
		FROM E021 Y
		)Z
		<![CDATA[
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID, DISTRICT_CD, (SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y 
		)
		,E033 AS (
		SELECT SCEN_ID, DISTRICT_CD, CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_VAL,
		CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_EMD_CNT > 0 THEN (SELECT MAX(VALUE_YEAR) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE SUBSTR(Y.DISTRICT_CD,0,5) ||'%' AND X.DISTRICT_CD <> Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
		END AS SCEN_YEAR,
		CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID
		
		FROM E032 Y
		)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, MDL_ID FROM E033
		)
		,E05 AS (
		SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
		)
		,E06 AS (
		SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
		)
		,E07 AS (
		SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
		)
		,E08 AS (
		SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
		WHERE ESTI.ITEM_ID = 
		#{item}
		)
		,E09 AS (
		SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
		)
		,E10 AS ( 
		SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
		)
		,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
		)
		,E12 AS (
		SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE 
		,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE 
		,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
		FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
		)
		,E13 AS(
		SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC)::TEXT AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, SGG.SD_NM, SGG.SGG_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
		JOIN E011 SGG ON ESTM.DISTRICT_CD = SGG.DISTRICT_CD 
		ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
		)
		]]>
	</sql>
	
	<sql id="wholeSd">
	<![CDATA[
		WITH E01 AS (
		SELECT DISTRICT_CD FROM DISTRICT_SD
		)
		,E011 AS(
		SELECT DISTRICT_CD, DISTRICT_NM AS SD_NM FROM DISTRICT_SD
		ORDER BY DISTRICT_CD ASC
		)
		,E02 AS (
		SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E021 AS (
		SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		,E022 AS (
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR) 
		END INDI_VAL 
		FROM(
		SELECT INDI_ID, DISTRICT_CD, CASE 
		WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD) 
		WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5)) 
		WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2)) 
		END INDI_YEAR
		,INDI_SPACE
		FROM E021 Y
		)Z
		)
		,E03 AS (
		SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID IN(SELECT INDI_ID FROM ITEM_INDICATOR WHERE ITEM_ID=
		#{item}
		))
		,E031 AS (
		SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		,E032 AS (
		SELECT SCEN_ID, DISTRICT_CD
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
		,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
		FROM E031 Y 
		)
		,E033 AS (
		SELECT SCEN_ID, DISTRICT_CD, CASE 
		WHEN M1_EMD_CNT > 0 THEN #{model}
		WHEN M1_SGG_CNT > 0 THEN #{model}
		WHEN M2_EMD_CNT > 0 THEN #{adjModel}
		WHEN M2_SGG_CNT > 0 THEN #{adjModel}
		END AS MDL_ID,
		CASE 
		WHEN M1_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 7 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		WHEN M1_SGG_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 5 AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		WHEN M2_EMD_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 7 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		WHEN M2_SGG_CNT > 0 THEN (SELECT AVG(SCEN_VAL) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD LIKE Y.DISTRICT_CD ||'%' AND LENGTH(X.DISTRICT_CD) = 5 AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) 
		END AS SCEN_VAL
		FROM E032 Y
		)
		,E04 AS (
		SELECT INDI_ID, DISTRICT_CD, INDI_VAL FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL FROM E033
		)
		,E05 AS (
		SELECT A.INDI_ID ,MAX(A.INDI_VAL) AS MAX_VALUE ,MIN(A.INDI_VAL) AS MIN_VALUE FROM E04 A GROUP BY INDI_ID 
		)
		,E06 AS (
		SELECT BASE.INDI_ID ,BASE.DISTRICT_CD ,BASE.INDI_VAL ,GNRL.MAX_VALUE ,GNRL.MIN_VALUE FROM E04 BASE LEFT JOIN E05 GNRL ON BASE.INDI_ID = GNRL.INDI_ID ORDER BY BASE.INDI_ID ASC, BASE.DISTRICT_CD 
		)
		,E07 AS (
		SELECT RSLT.INDI_ID ,RSLT.DISTRICT_CD ,CASE WHEN RSLT.MAX_VALUE-RSLT.MIN_VALUE = 0 THEN 0 ELSE ((RSLT.INDI_VAL-RSLT.MIN_VALUE)/(RSLT.MAX_VALUE-RSLT.MIN_VALUE)) END AS GNRL_VALUE FROM E06 RSLT
		)
		,E08 AS (
		SELECT ESTI.ITEM_ID ,ESTI.SECTOR_ID ,ESTI.INDI_ID ,INDI.DISTRICT_CD , ESTI.INDI_VAL_WEIGHT, INDI.GNRL_VALUE , (ESTI.INDI_VAL_WEIGHT * INDI.GNRL_VALUE) AS WEIGHT_GNRL_VALUE FROM ITEM_INDICATOR ESTI JOIN E07 INDI ON ESTI.INDI_ID = INDI.INDI_ID 
		WHERE ESTI.ITEM_ID = 
		#{item}
		)
		,E09 AS (
		SELECT GRSM.ITEM_ID ,GRSM.SECTOR_ID , GRSM.DISTRICT_CD , SUM(GRSM.WEIGHT_GNRL_VALUE)AS WEI_SUM_VALUE FROM E08 GRSM GROUP BY GRSM.ITEM_ID,GRSM.SECTOR_ID,GRSM.DISTRICT_CD 
		)
		,E10 AS ( 
		SELECT ESRS.ITEM_ID, ESRS.DISTRICT_CD , CASE ESRS.SECTOR_ID WHEN 'SEC01' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS CLIM , CASE ESRS.SECTOR_ID WHEN 'SEC02' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS SENS ,CASE ESRS.SECTOR_ID WHEN 'SEC03' THEN ESRS.WEI_SUM_VALUE ELSE 0.00 END AS ADAP FROM E09 ESRS
		)
		,E11 AS (SELECT ESTB.ITEM_ID ,ESTB.DISTRICT_CD , SUM(ESTB.CLIM) AS CLIM_VALUE ,SUM(ESTB.SENS) AS SENS_VALUE , SUM(ESTB.ADAP) AS ADAP_VALUE FROM E10 ESTB GROUP BY ESTB.ITEM_ID, ESTB.DISTRICT_CD
		)
		,E12 AS (
		SELECT ESWE.ITEM_ID ,ESMS.ITEM_NM , ESWE.DISTRICT_CD ,TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2) AS CLIM_VALUE 
		,TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2) AS SENS_VALUE , TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2) AS ADAP_VALUE 
		,TRUNC((TRUNC(ESWE.CLIM_VALUE*ESMS.CE_WEIGHT::NUMERIC,2)+TRUNC(ESWE.SENS_VALUE*ESMS.CS_WEIGHT::NUMERIC,2)-TRUNC(ESWE.ADAP_VALUE*ESMS.AA_WEIGHT::NUMERIC,2))::NUMERIC,2) AS ESTI_VALUE
		FROM ITEM_LIST ESMS RIGHT JOIN E11 ESWE ON ESWE.ITEM_ID = ESMS.ITEM_ID 
		)
		,E13 AS(
		SELECT ROW_NUMBER () OVER (ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC)::TEXT AS NO, ESTM.ITEM_NM , ESTM.DISTRICT_CD, SD.SD_NM, ESTM.CLIM_VALUE, ESTM.SENS_VALUE, ESTM.ADAP_VALUE, ESTM.ESTI_VALUE FROM E12 ESTM
		JOIN E011 SD ON ESTM.DISTRICT_CD = SD.DISTRICT_CD 
		ORDER BY ESTI_VALUE DESC, CLIM_VALUE ASC, SENS_VALUE ASC, ADAP_VALUE ASC
		)
			]]>
	</sql>

	<select id="selectWholeSgg" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeSgg" />
		<![CDATA[
			SELECT * FROM E13
			WHERE DISTRICT_CD like #{sido}||'%'
		]]>
	</select>

	<select id="selectWholeEmd" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeEmd" />
		<![CDATA[
			SELECT * FROM E13
		]]>
		<choose>
			<when test="!@org.springframework.util.ObjectUtils@isEmpty(sigungu)">
				WHERE DISTRICT_CD like #{sigungu}||'%'
			</when>
			<otherwise>
				WHERE DISTRICT_CD like #{sido}||'%'
			</otherwise>
		</choose>
	</select>
	
	<select id="selectEstimationIndiWeight" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeSgg" />
		<![CDATA[
			SELECT 
				SECTOR_ID, 
				INDI_ID,
				CASE
					WHEN INDI_ID LIKE 'IC'||'%'
					THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = E08.INDI_ID) 
					WHEN INDI_ID LIKE 'SC'||'%'
					THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = E08.INDI_ID)
					END AS INDI_NM, DISTRICT_CD, 
					TRUNC(COALESCE(WEIGHT_GNRL_VALUE,0):: NUMERIC, 2)AS WEIGHT_GNRL_VALUE 
			FROM E08
			WHERE DISTRICT_CD like #{sido}||'%'
			ORDER BY SECTOR_ID, INDI_ID, DISTRICT_CD
		]]>
	</select>

	<select id="selectEstimationEmdIndiWeight" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeEmd" />
		<![CDATA[
			SELECT
				SECTOR_ID,
				INDI_ID,
				CASE
					WHEN INDI_ID LIKE 'IC'||'%'
					THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = E08.INDI_ID)
					WHEN INDI_ID LIKE 'SC'||'%'
					THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = E08.INDI_ID)
					END AS INDI_NM, DISTRICT_CD,
					TRUNC(COALESCE(WEIGHT_GNRL_VALUE,0):: NUMERIC, 2)AS WEIGHT_GNRL_VALUE
			FROM E08
		]]>
		<choose>
			<when test="!@org.springframework.util.ObjectUtils@isEmpty(sigungu)">
				WHERE DISTRICT_CD like #{sigungu}||'%'
			</when>
			<otherwise>
				WHERE DISTRICT_CD like #{sido}||'%'
			</otherwise>
		</choose>
		ORDER BY SECTOR_ID, INDI_ID, DISTRICT_CD
	</select>
	
	<select id="selectWholeSd"	parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeSd" />
		<![CDATA[
			SELECT * FROM E13
		]]>
	</select>
	
	<select id="selectWholeSdExcel" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeSd" />
		<![CDATA[
			SELECT * FROM E13
		]]> 
	</select>
	
	<select id="selectWholeSggExcel" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeSgg" />
		SELECT 
			A.INDI_ID,
			CASE
				WHEN SUBSTR(INDI_ID,1,2) = 'IC'::TEXT THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = A.INDI_ID)
				WHEN SUBSTR(INDI_ID,1,2) = 'SC'::TEXT THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = A.INDI_ID)
			END AS INDI_NM,
			(SELECT DISTRICT_NM FROM DISTRICT_SD WHERE DISTRICT_SD.DISTRICT_CD = SUBSTR(A.DISTRICT_CD,1,2)) SD_NM,
			(SELECT DISTRICT_NM FROM DISTRICT_SGG WHERE DISTRICT_SGG.DISTRICT_CD = A.DISTRICT_CD )SGG_NM,
			A.DISTRICT_CD,
			INDI_VAL, 
			CASE
				WHEN SUBSTR(INDI_ID,1,2) = 'IC'::TEXT THEN (SELECT INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID = A.INDI_ID)
				WHEN SUBSTR(INDI_ID,1,2) = 'SC'::TEXT THEN (SELECT SCEN_UNIT FROM SCENARIO_LIST WHERE SCEN_ID = A.INDI_ID)
			END AS INDI_UNIT,
			INDI_YEAR, 
			COALESCE((SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID),'')AS MDL_ID 
		FROM E04 A
	</select>

	<select id="selectWholeEmdExcel" parameterType="EgovMap" resultType="EgovMap">
		<include refid="wholeEmd"/>
		SELECT
			A.INDI_ID,
			CASE
				WHEN SUBSTR(INDI_ID,1,2) = 'IC'::TEXT THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = A.INDI_ID)
				WHEN SUBSTR(INDI_ID,1,2) = 'SC'::TEXT THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = A.INDI_ID)
			END AS INDI_NM,
			(SELECT DISTRICT_NM FROM DISTRICT_SD WHERE DISTRICT_SD.DISTRICT_CD = SUBSTR(A.DISTRICT_CD,1,2)) SD_NM,
			(SELECT DISTRICT_NM FROM DISTRICT_SGG WHERE SUBSTR(DISTRICT_SGG.DISTRICT_CD,1,4) = SUBSTR(A.DISTRICT_CD,1,4) )SGG_NM,
			(SELECT DISTRICT_NM FROM DISTRICT_EMD WHERE DISTRICT_EMD.DISTRICT_CD = A.DISTRICT_CD) EMD_NM,
			A.DISTRICT_CD,
			INDI_VAL,
			CASE
				WHEN SUBSTR(INDI_ID,1,2) = 'IC'::TEXT THEN (SELECT INDI_UNIT FROM INDICATOR_LIST WHERE INDI_ID = A.INDI_ID)
				WHEN SUBSTR(INDI_ID,1,2) = 'SC'::TEXT THEN (SELECT SCEN_UNIT FROM SCENARIO_LIST WHERE SCEN_ID = A.INDI_ID)
			END AS INDI_UNIT,
			INDI_YEAR,
			COALESCE((SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID),'')AS MDL_ID
		FROM E04 A
		ORDER BY DISTRICT_CD,SECTOR_ID, INDI_ID
	</select>
	
	<select id="selectItemIndiList" parameterType="EgovMap" resultType="EgovMap">
		SELECT
			ITEM_ID,SECTOR_ID, INDI_ID,
			(SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = ITEM_INDICATOR_SYS.INDI_ID) AS INDI_NM
		FROM
			ITEM_INDICATOR_SYS
		WHERE 
			ITEM_ID = #{item} AND
			SECTOR_ID NOT IN ('SEC01')
		ORDER BY SECTOR_ID,INDI_ID
	</select>
	
	<select id="selectItemIndiAllList" parameterType="EgovMap" resultType="EgovMap">
		SELECT
			ITEM_ID, SECTOR_ID,
			CASE 
				WHEN SECTOR_ID ='SEC01' THEN (SELECT CE_WEIGHT FROM ITEM_LIST WHERE ITEM_ID = #{item})
				WHEN SECTOR_ID ='SEC02' THEN (SELECT CS_WEIGHT FROM ITEM_LIST WHERE ITEM_ID = #{item})
				WHEN SECTOR_ID ='SEC03' THEN (SELECT AA_WEIGHT FROM ITEM_LIST WHERE ITEM_ID = #{item})
			END AS SECTOR_WEIGHT, 
			INDI_ID,
			CASE
				WHEN SUBSTR(INDI_ID,1,2) = 'IC'::TEXT THEN (SELECT INDI_NM FROM INDICATOR_LIST WHERE INDI_ID = A.INDI_ID)
				WHEN SUBSTR(INDI_ID,1,2) = 'SC'::TEXT THEN (SELECT SCEN_NM FROM SCENARIO_LIST WHERE SCEN_ID = A.INDI_ID)
			END AS INDI_NM,
			INDI_VAL_WEIGHT
		FROM
			ITEM_INDICATOR AS A
		WHERE 
			ITEM_ID = #{item}	
		ORDER BY SECTOR_ID,INDI_ID
	</select>
	
	<select id="selectindiitemYearList" parameterType="EgovMap" resultType="EgovMap">
		SELECT
			DISTINCT INDI_ID, INDI_YEAR
		FROM 
			INDICATOR_DATA
		WHERE 
			INDI_ID = #{indi} AND
			LENGTH(DISTRICT_CD) BETWEEN 3 AND 6
		ORDER BY 
			INDI_YEAR DESC
	</select>
	<select id="selectindiitemSDYearList" parameterType="EgovMap" resultType="EgovMap">
		SELECT
			DISTINCT INDI_ID, INDI_YEAR
		FROM 
			INDICATOR_DATA
		WHERE 
			INDI_ID = #{indi} AND
			LENGTH(DISTRICT_CD) BETWEEN 2 AND 4
		ORDER BY 
			INDI_YEAR DESC
	</select>
	<select id="selectDistrictList" parameterType="EgovMap" resultType="EgovMap">
		SELECT 
			DISTRICT_CD, DISTRICT_NM AS DISTRICT_SD, '' AS DISTRICT_NM
		FROM
			DISTRICT_SD
		UNION ALL
		SELECT
			DISTRICT_CD, 
			(SELECT DISTRICT_NM FROM DISTRICT_SD AS B WHERE SUBSTRING(A.DISTRICT_CD,0,3) = B.DISTRICT_CD) AS DISTRICT_SD, DISTRICT_NM
		FROM 
			DISTRICT_SGG AS A
		ORDER BY DISTRICT_CD
	</select>

	<select id="selectDistrictEmdList" parameterType="EgovMap" resultType="EgovMap">
		SELECT
			DISTRICT_CD, DISTRICT_NM AS DISTRICT_SD, '' AS DISTRICT_SGG, '' AS DISTRICT_NM
		FROM
			DISTRICT_SD
		UNION ALL
		SELECT
			DISTRICT_CD,
			(SELECT DISTRICT_NM FROM DISTRICT_SD AS B WHERE SUBSTRING(A.DISTRICT_CD,0,3) = B.DISTRICT_CD) AS DISTRICT_SD,
			DISTRICT_NM AS DISTRICT_SGG,
			'' AS DISTRICT_NM
		FROM
			DISTRICT_SGG AS A
		UNION ALL
		SELECT
			DISTRICT_CD,
			(SELECT DISTRICT_NM FROM DISTRICT_SD AS B WHERE SUBSTRING(A.DISTRICT_CD,0,3) = B.DISTRICT_CD) AS DISTRICT_SD,
			(SELECT DISTRICT_NM FROM DISTRICT_SGG AS C WHERE SUBSTRING(A.DISTRICT_CD,1,4) = SUBSTRING(C.DISTRICT_CD,1,4)) AS DISTRICT_SGG,
			DISTRICT_NM
		FROM DISTRICT_EMD AS A
		ORDER BY DISTRICT_CD
	</select>

	<select id="selectEstimationResultEmdData"
			parameterType="EgovMap" resultType="EgovMap">
		<![CDATA[
		WITH E01 AS (
			SELECT DISTRICT_CD FROM DISTRICT_EMD
			WHERE DISTRICT_CD LIKE
				  #{sigungu}
					  ||'%'
		)
		   ,E011 AS(
			SELECT A.DISTRICT_CD, C.DISTRICT_NM AS SD_NM, B.DISTRICT_NM AS SGG_NM, A.DISTRICT_NM AS EMD_NM FROM DISTRICT_EMD A
																													JOIN DISTRICT_SGG B ON SUBSTR(A.DISTRICT_CD,1,5) = B.DISTRICT_CD
																													JOIN DISTRICT_SD C ON SUBSTR(A.DISTRICT_CD,1,2) = C.DISTRICT_CD
			ORDER BY DISTRICT_CD ASC
		)
		   ,E02 AS (
			SELECT INDI_ID,INDI_SPACE FROM INDICATOR_LIST WHERE INDI_ID =
																#{indi}
		)
		   ,E021 AS (
			SELECT A.INDI_ID, B.DISTRICT_CD, A.INDI_SPACE FROM E02 A CROSS JOIN E01 B
		)
		   ,E022 AS (
			SELECT INDI_ID, DISTRICT_CD, CASE
											 WHEN INDI_SPACE='SPA01' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = Z.DISTRICT_CD AND Z.INDI_YEAR = X.INDI_YEAR)
											 WHEN INDI_SPACE='SPA02' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,5) AND Z.INDI_YEAR = X.INDI_YEAR)
											 WHEN INDI_SPACE='SPA03' THEN (SELECT INDI_VAL FROM INDICATOR_DATA X WHERE 1=1 AND X.INDI_ID = Z.INDI_ID AND X.DISTRICT_CD = SUBSTR(Z.DISTRICT_CD,1,2) AND Z.INDI_YEAR = X.INDI_YEAR)
				END INDI_VAL
				 ,INDI_YEAR
			FROM(
					SELECT INDI_ID, DISTRICT_CD,
		]]>
					       <choose>
							   <when test="indiItem != null and indiItem.size!=0">
								   CASE
								       <foreach collection="indiItem" item="item" separator=" ">
										   WHEN INDI_ID = #{item.indiId}
								       		THEN #{item.indiYear}
									   </foreach>
								       END INDI_YEAR
							   </when>
							   <otherwise>
								   CASE
								   WHEN INDI_SPACE='SPA01' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = Y.DISTRICT_CD)
								   WHEN INDI_SPACE='SPA02' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5))
								   WHEN INDI_SPACE='SPA03' THEN (SELECT MAX(INDI_YEAR) FROM INDICATOR_DATA X WHERE X.INDI_ID = Y.INDI_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,2))
								   END INDI_YEAR
							   </otherwise>
						   </choose>
						 ,INDI_SPACE
					FROM E021 Y
				)Z
		<![CDATA[
		)
		   ,E03 AS (
			SELECT SCEN_ID,SCEN_CONSTRUCT FROM SCENARIO_LIST WHERE SCEN_ID =
																   #{indi}
		)
		   ,E031 AS (
			SELECT A.SCEN_ID, B.DISTRICT_CD, A.SCEN_CONSTRUCT FROM E03 A CROSS JOIN E01 B
		)
		   ,E032 AS (
			SELECT SCEN_ID ,DISTRICT_CD
				 ,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_EMD_CNT
				 ,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M1_SGG_CNT
				 ,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_EMD_CNT
				 ,(SELECT COUNT(*) FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year}) AS M2_SGG_CNT
			FROM E031 Y)
		   ,E033 AS (
			SELECT SCEN_ID ,DISTRICT_CD
				 , CASE
					   WHEN M1_EMD_CNT > 0 THEN #{model}
					   WHEN M1_SGG_CNT > 0 THEN #{model}
					   WHEN M2_EMD_CNT > 0 THEN #{adjModel}
					   WHEN M2_SGG_CNT > 0 THEN #{adjModel}
				END AS MDL_ID
				 , CASE
					   WHEN M1_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M1_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M2_EMD_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M2_SGG_CNT > 0 THEN (SELECT SCEN_VAL FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
				END AS SCEN_VAL
				 , CASE
					   WHEN M1_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M1_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{model} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M2_EMD_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = Y.DISTRICT_CD AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
					   WHEN M2_SGG_CNT > 0 THEN (SELECT VALUE_YEAR FROM SCENARIO_DATA X WHERE X.SCEN_ID = Y.SCEN_ID AND X.DISTRICT_CD = SUBSTR(Y.DISTRICT_CD,1,5) AND MDL_ID = #{adjModel} AND SCEN_SECTION = #{section} AND SCEN_YEAR = #{year})
				END AS  SCEN_YEAR
			FROM E032 Y)
		   ,E04 AS (
			SELECT INDI_ID, DISTRICT_CD, INDI_VAL, INDI_YEAR, '' AS MDL_ID FROM E022 UNION ALL SELECT SCEN_ID, DISTRICT_CD, SCEN_VAL, SCEN_YEAR, MDL_ID FROM E033
		)
		SELECT
			ROW_NUMBER () OVER (ORDER BY A.DISTRICT_CD ASC) AS NO
		,B.DISTRICT_CD AS EMD_CD
		,(SELECT DISTRICT_NM FROM DISTRICT_SD WHERE SUBSTR(B.DISTRICT_CD,1,2) = DISTRICT_SD.DISTRICT_CD) AS SD_NM
		,(SELECT DISTRICT_NM FROM DISTRICT_SGG WHERE SUBSTR(B.DISTRICT_CD,1,4) = SUBSTR(DISTRICT_SGG.DISTRICT_CD,1,4)) AS SGG_NM
		,B.DISTRICT_NM AS EMD_NM
		,CASE
			WHEN A.INDI_VAL<1 THEN REPLACE(TRUNC(A.INDI_VAL,2)::TEXT,'.00','')
			ELSE REPLACE(BTRIM(TO_CHAR(A.INDI_VAL,'999G999G999G999D99'),' '),'.00','')
		END AS INDI_VAL
		,A.INDI_YEAR
		,(SELECT CODE_NM FROM REF_CODE WHERE CODE_ID = A.MDL_ID) AS MDL_NM
		FROM E04 A
		JOIN
		DISTRICT_EMD B
		ON (A.DISTRICT_CD = B.DISTRICT_CD)
		]]>
		<choose>
			<when test="!@org.springframework.util.ObjectUtils@isEmpty(sigungu)">
				WHERE A.DISTRICT_CD like #{sigungu}||'%'
			</when>
			<otherwise>
				WHERE A.DISTRICT_CD like #{sido}||'%'
			</otherwise>
		</choose>
		ORDER BY A.DISTRICT_CD ASC
	</select>
</mapper>